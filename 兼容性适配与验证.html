<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>兼容性适配与验证 - utils-translator 用户操作手册</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">utils-translator 用户操作手册</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="兼容性适配与验证"><a class="header" href="#兼容性适配与验证">兼容性适配与验证</a></h1>
<p>在GNU utils中的工具经过Rust重写后，我们需要对其进行兼容性适配与验证，具体来说，要对其开展功能测试，以保证其功能的正确性。我们主要采用复用GNU已有的测试用例的方式，来确认Rust重写后的工具功能是否与原工具一致。</p>
<p>建议使用全新的GNU utils环境进行测试，对于Rust转译所对应的GNU utils版本，可以使用如下命令进行下载：</p>
<p>对binutils：</p>
<pre><code class="language-bash">wget https://ftp.gnu.org/gnu/binutils/binutils-2.37.tar.gz
tar -zxvf binutils-2.37.tar.gz
</code></pre>
<p>对coreutils：</p>
<pre><code class="language-bash">git clone --recurse-submodules https://github.com/coreutils/coreutils.git
cd coreutils
git fetch --all --tags 
git checkout tags/v9.0
</code></pre>
<h2 id="找到二进制路径"><a class="header" href="#找到二进制路径">找到二进制路径</a></h2>
<p>首先，为了能够运行测试，我们需要找到编译后的二进制文件的路径。在GNU utils中，二进制文件的路径一般在<code>MakeFile</code>中定义，可以通过<code>MakeFile</code>中的关键词来找到对应的二进制文件路径。</p>
<h3 id="寻找makefile中的可执行文件target目录"><a class="header" href="#寻找makefile中的可执行文件target目录">寻找MakeFile中的可执行文件TARGET目录</a></h3>
<p>在<code>MakeFile</code>中的搜索<code>FOR_TARGET</code>关键词，如<code>ld</code>命令对应<code>LD_FOR_TARGET</code>，可以看到结果如下：</p>
<pre><code class="language-makefile">LD_FOR_TARGET=$$r/$(HOST_SUBDIR)/ld/ld-new
</code></pre>
<p>又如<code>as</code>命令对应<code>AS_FOR_TARGET</code>，可以看到结果如下:</p>
<pre><code class="language-makefile">AS_FOR_TARGET=$$r/$(HOST_SUBDIR)/gas/as-new
</code></pre>
<h3 id="寻找编译后的二进制可执行文件"><a class="header" href="#寻找编译后的二进制可执行文件">寻找编译后的二进制可执行文件</a></h3>
<p>例：通过<code>find</code>命令寻找编译后的二进制文件：</p>
<pre><code class="language-bash">find ./ -type f ! -name "*.*" | grep "ld"
</code></pre>
<h3 id="仅限coreutils的简化版操作"><a class="header" href="#仅限coreutils的简化版操作">仅限coreutils的简化版操作</a></h3>
<p>在coreutils的测试环境中会更简单一些，因为coreutils的<code>MakeFile</code>中定义了<code>TESTS_ENVIRONMENT</code>变量，并会在测试时加载作为环境变量，其中部分片段如下：</p>
<pre><code class="language-makefile">TESTS_ENVIRONMENT = \
    ...
    PATH='$(abs_top_builddir)/src$(PATH_SEPARATOR)'"$$PATH" \
    ...
</code></pre>
<p>而向前查找<code>abs_top_builddir</code>可以发现其在<code>./configure</code>的时候被定义为了项目所在的文件夹，作为印证，我们确实可以直接在项目所在的文件夹的src目录下找到所有编译后的二进制文件。</p>
<h2 id="替换测试中的二进制"><a class="header" href="#替换测试中的二进制">替换测试中的二进制</a></h2>
<p>为了借用GNU已有的功能测试，我们需要修改和替换测试中调用的二进制，达到测试项目复用的目的。下面介绍两种替换方式。</p>
<h3 id="直接替换二进制文件"><a class="header" href="#直接替换二进制文件">直接替换二进制文件</a></h3>
<p>因为在<code>MakeFile</code>中已经定义了编译好后的target二进制文件路径，可以将rust重写后的二进制文件替换到对应的路径下并命名为对应的文件名，已实现对原二进制文件的覆盖。</p>
<p>如ld项目的二进制文件位于<code>binutils-2.37/ld/ld-new</code>，可以将rust重写后的二进制文件替换到<code>binutils-2.37/ld/ld-new</code>路径下并命名为<code>ld-new</code>。例如使用如下命令</p>
<pre><code class="language-bash">rm -rf ld/ld-new
cp /home/user/binutils-2.37/rust/ld/target/debug/ld ld/ld-new
</code></pre>
<p>如as项目的二进制文件位于<code>binutils-2.37/gas/as-new</code>，可以将rust重写后的二进制文件替换到<code>binutils-2.37/gas/as-new</code>路径下并命名为<code>as-new</code>。例如使用如下命令</p>
<pre><code class="language-bash">rm -rf gas/as-new
cp /home/user/binutils-2.37/rust/as/target/debug/as gas/as-new
</code></pre>
<p>对于coreutils中的项目，因为其所有二进制文件都存放于src文件夹下，因此我们可以直接将rust转译后的二进制替换到src文件夹下</p>
<pre><code class="language-bash">rsync -avh --progress /home/user/coreutils-rust/target/debug/ /home/user/coreutils-test/src/
</code></pre>
<h3 id="修改测试用例中的二进制文件路径"><a class="header" href="#修改测试用例中的二进制文件路径">修改测试用例中的二进制文件路径</a></h3>
<p>GNU的coreutils和binutils都使用DejaGnu测试框架，其中如使用二进制的路径等内容会在 testsuite/config/default.exp文件中
如ld项目的<code>testsuite/config/default.exp</code>中，搜索<code>ld-new</code>可见如下结果：</p>
<pre><code>...
if ![info exists ld] then {
  set ld [findfile $base_dir/ld-new $base_dir/ld-new [transform ld]] 
}
...
if ![info exists LD] then {
  set LD [findfile $base_dir/ld-new ./ld-new [transform ld]] 
}
...
# Set LD CLASS to "64bit" for a 64-bit *host* linker.
if { ![info exists LD_CLASS] } then {
  set REAL_LD [findfile $base_dir/.libs/ld-new .libs/ld-new $LD [transform ld]]
  set readelf_output [run_host_cmd "$READELF" "-h $REAL_LD"] 
  if { [regexp {[ \t]+Class:[ \t]+ELF64} $readelf_output] } then {
    set LD_CLASS 64bit
  } else {
    set LD_CLASS 32bit
  }
}
...
</code></pre>
<p>可按照如下方式修改</p>
<pre><code>...
set ld /home/user/binutils-2.37/rust/ld/target/debug/ld
if ![info exists ld] then {
    set ld [findfile $base_dir/ld-new $base_dir/ld-new [transform ld]]
}
...
set LD /home/user/binutils-2.37/rust/ld/target/debug/ld
if ![info exists ld] then {
    set LD [findfile $base_dir/ld-new ./ld-new [transform ld]]
}
...
set REAL_LD /home/user/binutils-2.37/rust/ld/target/debug/ld
# Set LD_CLASS to "64bit" for a 64-bit *host* linker.
if { ! [info exists LD_CLASS] } then {
    set REAL_LD [findfile $base_dir/.libs/ld-new .libs/ld-new $LD [transform ld]]
    set readelf_output [run_host_cmd "$READELF" "-h $REAL_LD"]
    if {[regexp {[\t]+Class:[\t]+ELF64} $readelf_output] } then {
        set LD_CLASS "64bit"
    } else {
        set LD_CLASS "32bit"
    }
}
...
</code></pre>
<p>对于coreutils中的项目，因为其所有二进制文件都存放于src文件夹下，因此我们仅需将<code>$(abs_top_builddir)/src</code>的地址修改为rust重写后的二进制存放目录即可</p>
<h2 id="运行测试并生成测试报告"><a class="header" href="#运行测试并生成测试报告">运行测试并生成测试报告</a></h2>
<h3 id="运行测试"><a class="header" href="#运行测试">运行测试</a></h3>
<p>在binutils中，可以通过如下命令运行完整测试：</p>
<pre><code class="language-bash">./configure
make check
</code></pre>
<p>也可以分别运行下列命令分别运行binutils、gas、ld的测试：</p>
<pre><code class="language-bash">make check-binutils
make check-gas
make check-ld
</code></pre>
<p>在 binutils 测试运行完成后，结果摘要将位于 binutils 目录中的 binutils.sum 文件中。更详细的信息也将在 binutils/binutils.log 文件中提供。对于 gas 测试套件，结果位于 gas/testsuite/gas.sum 和 gas/testsuite/gas.log 文件中，而对于 ld 测试套件，它们位于 ld/ld.sum 和 ld/ld.log 文件中。</p>
<p>在 coreutils 中，可以通过如下命令运行完整测试：</p>
<pre><code class="language-bash">./bootstrap --skip-po --force 
./configure --with-openssl --enable-install-program=arch --enable-no-install-program=kill,uptime
RUN make check -j $(nproc) RUN_EXPENSIVE_TESTS=yes RUN_VERY_EXPENSIVE_TESTS=yes
</code></pre>
<p>在 coreutils 测试运行完成后，结果和详细的运行记录将位于 coreutils 目录中的 tests/test-suite.log 文件中。</p>
<h3 id="生成测试报告"><a class="header" href="#生成测试报告">生成测试报告</a></h3>
<p>在所提供的Dockfile中，我们分别准备一份使用了GNU utils原本二进制的测试环境和一份使用了Rust重写后的二进制的测试环境，以便于对比。对于binutils，这两个环境分别位于<code>/home/user/FunctionTest/binutils</code>和<code>/home/user/FunctionTest/rust-binutils</code>；对于coreutils，这两个环境分别位于<code>/home/user/test/coreutils-origin</code>和<code>/home/user/test/coreutils-rust</code>。</p>
<p>我们提供了一个<code>diff.py</code>脚本以便快速对比两个测试环境的测试环境的异同。在binutils中，运行：</p>
<pre><code class="language-bash">cd /home/user/FunctionTest &amp;&amp; python3 diff.py
</code></pre>
<p>产生形如下方的输出：</p>
<pre><code class="language-bash">----------ld----------
GNU:PASS: bootstrap
Rust:UNTESTED: bootstrap

GNU:PASS: bootstrap with strip
Rust:UNTESTED: bootstrap with strip

GNU:PASS: bootstrap with -Wl,--traditional-format
Rust:UNTESTED: bootstrap with -Wl,--traditional-format

GNU:PASS: bootstrap with -Wl,--no-keep-memory
Rust:UNTESTED: bootstrap with -Wl,--no-keep-memory

GNU:PASS: bootstrap with -Wl,--relax
Rust:UNTESTED: bootstrap with -Wl,--relax
----------gas----------
No difference found.\n

----------binutils----------
No difference found.\n
</code></pre>
<p>在coreutils中，运行：</p>
<pre><code class="language-bash">cd /home/user/test &amp;&amp; python3 diff.py
</code></pre>
<p>产生形如下方的输出：</p>
<pre><code class="language-bash">Functional Test Result: 

Rust:
FAIL: tests/misc/sort-month
FAIL: tests/misc/invalid-opt
FAIL: tests/misc/sort
FAIL: tests/misc/cut
FAIL: tests/misc/numfmt
FAIL: tests/misc/join

GNU:
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="utils重构实践.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="稳定性与性能测试.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="utils重构实践.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="稳定性与性能测试.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
